#!/usr/bin/env bash
# gw-doctor: contract verification tool (read-only, no auto-fix)
# DOES NOT FIX ANYTHING. Detects issues and provides guidance only.

SCRIPT_DIR="$(cd "${0%/*}" && pwd)"

usage() {
  echo "contracted command: gw-doctor"
  echo "Usage: gw-doctor <command> [--info]"
  echo ""
  echo "Commands:"
  echo "  check-tools    Verify required tools are available"
  echo "  forbid-scan    Check for prohibited items (tmux)"
  echo "  key-check      Verify SSH key health (read-only, no fix)"
  echo ""
  echo "Options:"
  echo "  --info         Show information only, exit 0 (overrides FAIL behavior)"
  echo ""
  echo "IMPORTANT: This tool DOES NOT FIX anything."
  echo "            It only detects issues and provides guidance."
  echo "            For repairs, use external tools (ssh-keygen, chmod, etc.)."
  exit 0
}

check_key_health() {
  local key_file="${1:-$HOME/.ssh/id_rsa}"
  local status="ok"

  if [ ! -f "$key_file" ]; then
    echo "FAIL: key file not found: $key_file"
    return 1
  fi

  if [ ! -r "$key_file" ]; then
    echo "FAIL: key file not readable: $key_file"
    return 1
  fi

  if ! ssh-keygen -y -f "$key_file" >/dev/null 2>&1; then
    echo "FAIL: key is corrupted or passphrase-protected: $key_file"
    return 1
  fi

  local perms
  perms=$(stat -c "%a" "$key_file" 2>/dev/null || echo "unknown")
  if [ "$perms" != "600" ] && [ "$perms" != "400" ]; then
    echo "WARN: key permissions are too open ($perms), recommend 600 or 400: $key_file"
  fi

  echo "OK: key appears healthy: $key_file"
  return 0
}

INFO_MODE=false
CMD=""

for arg in "$@"; do
  case "$arg" in
    --info)
      INFO_MODE=true
      ;;
    --help|-h)
      usage
      ;;
    -*)
      echo "Unknown option: $arg"
      exit 1
      ;;
    *)
      if [ -z "$CMD" ]; then
        CMD="$arg"
      else
        echo "Error: only one command supported"
        exit 1
      fi
      ;;
  esac
done

if [ -z "$CMD" ]; then
  CMD="usage"
fi

case "$CMD" in
  usage)
    usage
    ;;
  check-tools)
    local fail=0
    for tool in fzf ssh; do
      if ! command -v "$tool" >/dev/null 2>&1; then
        echo "FAIL: required tool '$tool' not found"
        fail=1
      fi
    done
    if [ $fail -eq 0 ]; then
      echo "OK: All required tools available: fzf, ssh"
    fi
    [ "$INFO_MODE" = true ] && exit 0 || exit $fail
    ;;
  forbid-scan)
    local fail=0
    if grep -rIw --exclude=gw-doctor "tmux" "$SCRIPT_DIR" 2>/dev/null; then
      echo "FAIL: tmux detected in artifacts"
      fail=1
    fi
    if [ $fail -eq 0 ]; then
      echo "OK: No forbidden items detected"
    fi
    [ "$INFO_MODE" = true ] && exit 0 || exit $fail
    ;;
  key-check)
    local any_checked=false
    local any_failed=false
    shift
    if [ $# -gt 0 ]; then
      for key in "$@"; do
        any_checked=true
        if ! check_key_health "$key"; then
          any_failed=true
        fi
      done
    else
      any_checked=true
      if ! check_key_health; then
        any_failed=true
      fi
    fi
    if [ "$any_checked" = true ]; then
      if [ "$any_failed" = true ]; then
        echo "FAIL: Some keys have issues (see above)"
        [ "$INFO_MODE" = true ] && exit 0 || exit 1
      else
        echo "OK: All checked keys are healthy"
        exit 0
      fi
    fi
    echo "Usage: gw-doctor key-check [--info] [key_file ...]"
    exit 0
    ;;
  *)
    echo "Unknown command: $CMD"
    usage
    exit 1
    ;;
esac
