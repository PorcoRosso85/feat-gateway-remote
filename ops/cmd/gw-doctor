#!/usr/bin/env bash
# gw-doctor: contract verification tool

SCRIPT_DIR="$(cd "${0%/*}" && pwd)"

case "${1:-check}" in
  check-tools)
    # Check required tools from contract
    for tool in fzf ssh zmx; do
      if ! command -v "$tool" >/dev/null 2>&1; then
        echo "ERROR: required tool '$tool' not found"
        exit 1
      fi
    done
    echo "All required tools available: fzf, ssh, zmx"
    exit 0
    ;;
  forbid-scan)
    # Static forbid scan: check for prohibited items in artifacts
    fail=0

    # tmux injection check (word boundary, exclude this script)
    # -r: recursive, -I: ignore binary, -w: word boundary
    if grep -rIw --exclude=gw-doctor "tmux" "$SCRIPT_DIR" 2>/dev/null; then
      echo "FAIL: tmux detected in output files"
      fail=1
    fi

    if [ $fail -eq 0 ]; then
      echo "OK: No forbidden items detected"
    fi
    exit $fail
    ;;
  *)
    echo "contracted command: gw-doctor"
    echo "Usage: gw-doctor check-tools | forbid-scan"
    ;;
esac
