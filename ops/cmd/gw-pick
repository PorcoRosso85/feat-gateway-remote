#!/usr/bin/env bash
# gw-pick: Select SSH host via fzf

trap 'echo "Cancelled" && exit 0' INT

if ! command -v fzf >/dev/null 2>&1; then
  echo "contracted command: gw-pick (fzf not available)"
  exit 1
fi

if ! command -v ssh >/dev/null 2>&1; then
  echo "contracted command: gw-pick (openssh not available)"
  exit 1
fi

get_hosts_from_ssh_config() {
  if [ -f ~/.ssh/config ]; then
    grep -i "^Host " ~/.ssh/config 2>/dev/null | awk '{print $2}' | grep -v '^\*$' || true
  fi
}

HOSTS=$(get_hosts_from_ssh_config)

if [ ! -t 1 ]; then
  echo "contracted command: gw-pick (uses fzf)"
  echo "Usage: gw-pick [options]"
  echo ""
  echo "Options:"
  echo "  --height <rows>  Set fzf height"
  echo "  --reverse        Show options in reverse"
  if [ -n "$HOSTS" ]; then
    echo ""
    echo "Available hosts from ~/.ssh/config:"
    echo "$HOSTS" | head -5
  fi
  echo ""
  echo "Or enter host manually: gw-pick user@host"
  exit 0
fi

OPTIONS=()
if [ -n "$HOSTS" ]; then
  while IFS= read -r host; do
    [ -z "$host" ] && continue
    OPTIONS+=("ssh: $host")
  done <<< "$HOSTS"
fi
OPTIONS+=("manual: Enter host manually")

CHOICE=$(printf '%s\n' "${OPTIONS[@]}" | fzf --height 50% --reverse --prompt "Select SSH target: ")

if [ -z "$CHOICE" ]; then
  echo "Cancelled"
  exit 0
fi

if [[ "$CHOICE" == ssh:* ]]; then
  HOST=$(echo "$CHOICE" | sed 's/ssh: //')
  echo "Selected host: $HOST"
  exec gw-ssh "$HOST"
elif [[ "$CHOICE" == manual:* ]]; then
  echo "Enter host (user@host or hostname):"
  read -r HOST
  if [ -n "$HOST" ]; then
    exec gw-ssh "$HOST"
  else
    echo "Cancelled"
    exit 0
  fi
fi

exit 0
